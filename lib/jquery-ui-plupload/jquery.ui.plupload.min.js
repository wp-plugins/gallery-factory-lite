jQuery.widget.bridge("uibutton", jQuery.ui.button);
(function(v,w,e,k,c){function g(a){return e.translate(a)||a}var t={};c.widget("ui.plupload",{widgetEventPrefix:"",contents_bak:"",options:{browse_button_hover:"ui-state-hover",browse_button_active:"ui-state-active",filters:{},buttons:{browse:!0,start:!0,stop:!0},views:{list:!0,thumbs:!1,active:"list",remember:!0},thumb_width:140,thumb_height:140,multiple_queues:!0,dragdrop:!0,autostart:!1,sortable:!1,rename:!1},FILE_COUNT_ERROR:-9001,_create:function(){var a=this.element.attr("id");a||(a=e.guid(),
    this.element.attr("id", a));
    this.id = a;
    this.contents_bak = this.element.html();
    var b = this.element;
    b.id = b.attr("id");
    b.html('<div class="plupload_wrapper"><div class="plupload_container"><div class="plupload_content"><div class="plupload_droptext">' + g("Drag files here") + '</div><ul class="plupload_filelist_content"> </ul><div class="plupload_clearer">&nbsp;</div></div><table class="plupload_filelist plupload_filelist_footer"><tr><td class="plupload_cell plupload_file_name"><div class="plupload_buttons">\x3c!-- Visible --\x3e<a class="plupload_button plupload_add">' +
g("Add Files")+'</a>&nbsp;<a class="plupload_button plupload_start">'+g("Start Upload")+'</a>&nbsp;<a class="plupload_button plupload_stop plupload_hidden">'+g("Stop Upload")+'</a>&nbsp;<a class="plupload_button plupload_cancel">'+g("Cancel")+'</a>&nbsp;</div><div class="plupload_started plupload_hidden">\x3c!-- Hidden --\x3e<div class="plupload_progress plupload_right"><div class="plupload_progress_container"></div></div><div class="plupload_cell plupload_upload_status"></div><div class="plupload_clearer">&nbsp;</div></div></td><td class="plupload_file_status"><span class="plupload_total_status">0%</span></td><td class="plupload_file_size"><span class="plupload_total_file_size">0 kb</span></td><td class="plupload_file_action"></td></tr></table></div><input class="plupload_count" value="0" type="hidden"></div>');
this.container=c(".plupload_container",this.element).attr("id",a+"_container");this.content=c(".plupload_content",this.element);c.fn.resizable&&this.container.resizable({handles:"s",minHeight:300});this.filelist=c(".plupload_filelist_content",this.container).attr({id:a+"_filelist",unselectable:"on"});this.browse_button=c(".plupload_add",this.container).attr("id",a+"_browse");this.start_button=c(".plupload_start",this.container).attr("id",a+"_start");this.stop_button=c(".plupload_stop",this.container).attr("id",
        a + "_stop");
    this.cancel_button = c(".plupload_cancel", this.container).attr("id", a + "_cancel");
    this.thumbs_switcher = c("#" + a + "_view_thumbs");
    this.list_switcher = c("#" + a + "_view_list");
    c.ui.button && (this.browse_button.uibutton({
        icons: {primary: "ui-icon-circle-plus"},
        disabled: !0
    }), this.start_button.uibutton({
        icons: {primary: "ui-icon-circle-arrow-e"},
        disabled: !0
    }), this.stop_button.uibutton({icons: {primary: "ui-icon-circle-close"}}), this.cancel_button.uibutton({icons: {primary: "ui-icon-circle-close"}}), this.list_switcher.uibutton({
        text: !1,
        icons: {secondary: "ui-icon-grip-dotted-horizontal"}
    }), this.thumbs_switcher.uibutton({text: !1, icons: {secondary: "ui-icon-image"}}));
    this.progressbar = c(".plupload_progress_container", this.container);
    c.ui.progressbar && this.progressbar.progressbar();
    this.counter = c(".plupload_count", this.element).attr({id: a + "_count", name: a + "_count"});
    this._initUploader()
},
    _initUploader: function () {
        var a = this, b = this.id, f = {container: b + "_buttons", browse_button: b + "_browse"};
        c(".plupload_buttons", this.element).attr("id", b + "_buttons");
        if (a.options.dragdrop) {
            var d = this.filelist.parent();
            d.attr("id", this.id + "_dropbox");
            f.drop_element = this.id + "_dropbox";
            d.on({
                dragenter: function (a) {
                    c(this).addClass("drop_active")
                }, dragleave: function (a) {
                    c(this).removeClass("drop_active")
                }, drop: function (a) {
                    c(this).removeClass("drop_active");
                    c(this).find(".plupload_droptext").remove()
                }
            })
        }
        this.filelist.on("click", function (b) {
            c(b.target).hasClass("plupload_action_icon") && (a.removeFile(c(b.target).closest(".plupload_file").attr("id")), b.preventDefault())
        });
        b = this.uploader = t[b] = new e.Uploader(c.extend(this.options, f));
        a.options.views.thumbs && (b.settings.required_features.display_media = !0);
        a.options.max_file_count && e.extend(b.getOption("filters"), {max_file_count: a.options.max_file_count});
        e.addFileFilter("max_file_count", function (b, c, e) {
            b <= this.files.length - (this.total.uploaded + this.total.failed) ? (a.browse_button.uibutton("disable"), this.disableBrowse(), this.trigger("Error", {
                code: a.FILE_COUNT_ERROR,
                message: g("File count error."),
                file: c
            }), e(!1)) : e(!0)
        });
b.bind("Error",function(b,c){var f,d="";f="<strong>"+c.message+"</strong>";switch(c.code){case e.FILE_EXTENSION_ERROR:d=k.sprintf(g("File: %s"),c.file.name);break;case e.FILE_SIZE_ERROR:d=k.sprintf(g("File: %s, size: %d, max file size: %d"),c.file.name,e.formatSize(c.file.size),e.formatSize(e.parseSize(b.getOption("filters").max_file_size)));break;case e.FILE_DUPLICATE_ERROR:d=k.sprintf(g("%s already present in the queue."),c.file.name);break;case a.FILE_COUNT_ERROR:d=k.sprintf(g("Upload element accepts only %d file(s) at a time. Extra files were stripped."),
    b.getOption("filters").max_file_count || 0);
    break;
    case e.IMAGE_FORMAT_ERROR:
        d = g("Image format either wrong or not supported.");
        break;
    case e.IMAGE_MEMORY_ERROR:
        d = g("Runtime ran out of available memory.");
        break;
    case e.HTTP_ERROR:
        d = g("Upload URL might be wrong or doesn't exist.")
}
    f += " <br /><i>" + d + "</i>";
    a._trigger("error", null, {up: b, error: c});
    c.code === e.INIT_ERROR ? setTimeout(function () {
        a.destroy()
    }, 1) : a.notify("error", f)
});
        b.bind("PostInit", function (b) {
            a.options.buttons.browse ? a.browse_button.uibutton("enable") :
                (a.browse_button.uibutton("disable").hide(), b.disableBrowse(!0));
            a.options.buttons.start || a.start_button.uibutton("disable").hide();
            a.options.buttons.stop || a.stop_button.uibutton("disable").hide();
            a.options.dragdrop && b.features.dragdrop && a.filelist.parent().addClass("plupload_dropbox");
            a._enableViewSwitcher();
            a.start_button.click(function (b) {
                c(this).uibutton("option", "disabled") || a.start();
                b.preventDefault()
            });
            a.stop_button.click(function (b) {
                a.stop();
                c("#vls-gf-upload-panel").slideUp();
                a.clearQueue();
                b.preventDefault()
            });
            a.cancel_button.click(function (b) {
                a.clearQueue();
                b.preventDefault()
            });
            a._trigger("ready", null, {up: b})
        });
        b.init();
        b.bind("FileFiltered", function (b, c) {
            a._addFiles(c)
        });
        b.bind("FilesAdded", function (b, d) {
            a._trigger("selected", null, {up: b, files: d});
            a.options.sortable && c.ui.sortable && a._enableSortingList();
            a._trigger("updatelist", null, {filelist: a.filelist});
            a.options.autostart && setTimeout(function () {
                a.start()
            }, 10)
        });
        b.bind("FilesRemoved", function (b, d) {
            c.ui.sortable && a.options.sortable &&
            c("tbody", a.filelist).sortable("destroy");
            c.each(d, function (a, b) {
                c("#" + b.id).toggle("highlight", function () {
                    c(this).remove()
                })
            });
            b.files.length && a.options.sortable && c.ui.sortable && a._enableSortingList();
            a._trigger("updatelist", null, {filelist: a.filelist});
            a._trigger("removed", null, {up: b, files: d})
        });
        b.bind("QueueChanged StateChanged", function () {
            a._handleState()
        });
        b.bind("UploadFile", function (b, c) {
            a._handleFileStatus(c)
        });
        b.bind("FileUploaded", function (b, c) {
            a._handleFileStatus(c);
            a._trigger("uploaded",
                null, {up: b, file: c})
        });
        b.bind("UploadProgress", function (b, c) {
            a._handleFileStatus(c);
            a._updateTotalProgress();
            a._trigger("progress", null, {up: b, file: c})
        });
        b.bind("UploadComplete", function (b, c) {
            a._addFormFields();
            a._trigger("complete", null, {up: b, files: c})
        })
    },
    _setOption: function (a, b) {
        "buttons" == a && "object" == typeof b && (b = c.extend(this.options.buttons, b), b.browse ? (this.browse_button.uibutton("enable").show(), this.uploader.disableBrowse(!1)) : (this.browse_button.uibutton("disable").hide(), this.uploader.disableBrowse(!0)),
            b.start ? this.start_button.uibutton("enable").show() : this.start_button.uibutton("disable").hide(), b.stop ? this.start_button.uibutton("enable").show() : this.stop_button.uibutton("disable").hide());
        this.uploader.settings[a] = b
    },
    start: function () {
        this.uploader.start();
        this._trigger("start", null, {up: this.uploader})
    },
    stop: function () {
        this.uploader.stop();
        this._trigger("stop", null, {up: this.uploader})
    },
    enable: function () {
        this.browse_button.uibutton("enable");
        this.uploader.disableBrowse(!1)
    },
    disable: function () {
        this.browse_button.uibutton("disable");
        this.uploader.disableBrowse(!0)
    },
    getFile: function (a) {
        return "number" === typeof a ? this.uploader.files[a] : this.uploader.getFile(a)
    },
    getFiles: function () {
        return this.uploader.files
    },
    removeFile: function (a) {
        "string" === e.typeOf(a) && (a = this.getFile(a));
        this.uploader.removeFile(a)
    },
    clearQueue: function () {
        this.uploader.splice()
    },
    getUploader: function () {
        return this.uploader
    },
    refresh: function () {
        this.uploader.refresh()
    },
    notify: function (a, b) {
        var f = c('<div class="plupload_message"><span class="plupload_message_close ui-icon ui-icon-circle-close" title="' +
        g("Close") + '"></span><p><span class="ui-icon"></span>' + b + "</p></div>");
        f.addClass("ui-state-" + ("error" === a ? "error" : "highlight")).find("p .ui-icon").addClass("ui-icon-" + ("error" === a ? "alert" : "info")).end().find(".plupload_message_close").click(function () {
            f.remove()
        }).end();
        c(".plupload_header", this.container).append(f)
    },
    destroy: function () {
        this.uploader.destroy();
        c(".plupload_button", this.element).unbind();
        c.ui.button && c(".plupload_add, .plupload_start, .plupload_stop", this.container).uibutton("destroy");
        c.ui.progressbar && this.progressbar.progressbar("destroy");
        c.ui.sortable && this.options.sortable && c("tbody", this.filelist).sortable("destroy");
        this.element.empty().html(this.contents_bak);
        this.contents_bak = "";
        c.Widget.prototype.destroy.apply(this)
    },
    _handleState: function () {
        var a = this.uploader, b = a.files.length - (a.total.uploaded + a.total.failed), f = a.getOption("filters").max_file_count || 0;
        e.STARTED === a.state ? (c([]).add(this.stop_button).add(".plupload_started").removeClass("plupload_hidden"), this.start_button.uibutton("disable"),
            this.cancel_button.uibutton("disable").hide(), this.options.multiple_queues || (this.browse_button.uibutton("disable"), a.disableBrowse()), c(".plupload_upload_status", this.element).html(k.sprintf(g("Uploaded %d/%d files"), a.total.uploaded, a.files.length)), c(".plupload_header_content", this.element).addClass("plupload_header_content_bw")) : e.STOPPED === a.state && (c([]).add(this.stop_button).add(".plupload_started").addClass("plupload_hidden"), b ? this.start_button.uibutton("enable") : this.start_button.uibutton("disable"),
            this.cancel_button.uibutton("enable").show(), this.options.multiple_queues && c(".plupload_header_content", this.element).removeClass("plupload_header_content_bw"), this.options.multiple_queues && f && f > b && (this.browse_button.uibutton("enable"), a.disableBrowse(!1)), this._updateTotalProgress());
        a.refresh()
    },
    _handleFileStatus: function (a) {
        var b = c("#" + a.id), f, d;
        if (b.length) {
            switch (a.status) {
                case e.DONE:
                    f = "plupload_done";
                    d = "plupload_action_icon ui-icon ui-icon-circle-check";
                    break;
                case e.FAILED:
                    f = "ui-state-error plupload_failed";
d="plupload_action_icon ui-icon ui-icon-alert";break;case e.QUEUED:f="plupload_delete";d="plupload_action_icon ui-icon ui-icon-circle-minus";break;case e.UPLOADING:f="ui-state-highlight plupload_uploading";d="plupload_action_icon ui-icon ui-icon-circle-arrow-w";var m=c(".plupload_scroll",this.container),h=m.scrollTop(),g=m.height(),k=b.position().top+b.height();g<k&&m.scrollTop(h+k-g);b.find(".plupload_file_percent").html(a.percent+"%").end().find(".plupload_file_progress").css("width",a.percent+
"%").end().find(".plupload_file_size").html(e.formatSize(a.size))}b.attr("class",f+" ui-state-default plupload_file").find(".plupload_action_icon").attr("class",d)}},_updateTotalProgress:function(){var a=this.uploader;this.filelist[0].scrollTop=this.filelist[0].scrollHeight;this.progressbar.progressbar("value",a.total.percent);this.element.find(".plupload_total_status").html(a.total.percent+"%").end().find(".plupload_total_file_size").html(e.formatSize(a.total.size)).end().find(".plupload_upload_status").html(k.sprintf(g("Uploaded %d/%d files"),
a.total.uploaded,a.files.length))},_displayThumbs:function(){function a(a,b,c){var d;a.on(b,function(){clearTimeout(d);d=setTimeout(function(){clearTimeout(d);c()},300)})}function b(){var a=Math.floor(h.content.scrollTop()/l)*n;p=c(".plupload_file",h.filelist).slice(a,a+r).filter(".plupload_file_loading").get()}function f(){function d(){if("thumbs"===h.view_mode){if(!g||!l){var a=c(".plupload_file:eq(0)",h.filelist);g=a.outerWidth(!0);l=a.outerHeight(!0)}var a=h.content.width(),f=h.content.height();
n=Math.floor(a/g);r=n*(Math.ceil(f/l)+1);b();e()}}c.fn.resizable&&a(h.container,"resize",d);a(h.window,"resize",d);a(h.content,"scroll",d);h.element.on("viewchanged selected",d);d()}function d(a,b){var d=new k.Image;d.onload=function(){var b=c("#"+a.id+" .plupload_file_thumb",h.filelist).html("");this.embed(b[0],{width:h.options.thumb_width,height:h.options.thumb_height,crop:!0,swf_url:k.resolveUrl(h.options.flash_swf_url),xap_url:k.resolveUrl(h.options.silverlight_xap_url)})};d.bind("embedded error",
function(){c("#"+a.id,h.filelist).removeClass("plupload_file_loading");this.destroy();setTimeout(b,1)});d.load(a.getSource())}function e(){"thumbs"!==h.view_mode||q||(b(),p.length&&(q=!0,d(h.getFile(c(p.shift()).attr("id")),function(){q=!1;e()})))}var h=this,g,l,n,r=0,p=[],q=!1;if(this.options.views.thumbs)this.element.on("selected",function u(){h.element.off("selected",u);f()})},_addFiles:function(a){var b=this,f="";"array"!==e.typeOf(a)&&(a=[a]);c.each(a,function(a,c){var g=k.Mime.getFileExtension(c.name)||
"none";f+='<li class="plupload_file ui-state-default plupload_file_loading plupload_delete" id="%id%"><div class="plupload_file_thumb" style="width:%thumb_width%px;height:%thumb_height%px;"><div class="plupload_file_dummy ui-widget-content"><span class="ui-state-disabled"></span></div></div><div class="plupload_file_status"><div class="plupload_file_progress"></div></div><div class="plupload_file_name" title="%name%"><span class="plupload_file_name_wrapper">%name%</span></div><div class="plupload_file_action"><div class="plupload_action_icon ui-icon ui-icon-circle-minus"></div></div></li>'.replace(/%(\w+)%/g,
function(a,d){switch(d){case "thumb_width":case "thumb_height":return b.options[d];case "size":return e.formatSize(c.size);case "ext":return g;default:return c[d]||""}})});b.filelist.append(f);c(".plupload_droptext").remove()},_addFormFields:function(){var a=this;c(".plupload_file_fields",this.filelist).html("");e.each(this.uploader.files,function(b,f){var d="",g=a.id+"_"+f;b.target_name&&(d+='<input type="hidden" name="'+g+'_tmpname" value="'+e.xmlEncode(b.target_name)+'" />');d+='<input type="hidden" name="'+
g+'_name" value="'+e.xmlEncode(b.name)+'" />';d+='<input type="hidden" name="'+g+'_status" value="'+(b.status===e.DONE?"done":"failed")+'" />';c("#"+b.id).find(".plupload_file_fields").html(d)});this.counter.val(this.uploader.files.length)},_viewChanged:function(a){this.options.views.remember&&c.cookie&&c.cookie("plupload_ui_view",a,{expires:7,path:"/"});"IE"===k.Env.browser&&7>k.Env.version&&this.content.attr("style",'height:expression(document.getElementById("'+this.id+'_container").clientHeight - '+
("list"===a?132:102)+")");this.container.removeClass("plupload_view_list plupload_view_thumbs").addClass("plupload_view_"+a);this.view_mode=a;this._trigger("viewchanged",null,{view:a})},_enableViewSwitcher:function(){var a=this,b,f=c(".plupload_view_switch",this.container),d;e.each(["list","thumbs"],function(b){a.options.views[b]||f.find('[for="'+a.id+"_view_"+b+'"], #'+a.id+"_view_"+b).remove()});d=f.find(".plupload_button");1===d.length?(f.hide(),b=d.eq(0).data("view"),this._viewChanged(b)):c.ui.button&&
1<d.length?(this.options.views.remember&&c.cookie&&(b=c.cookie("plupload_ui_view")),~e.inArray(b,["list","thumbs"])||(b=this.options.views.active),f.show().buttonset().find(".ui-button").click(function(d){b=c(this).data("view");a._viewChanged(b);d.preventDefault()}),d=f.find('[for="'+a.id+"_view_"+b+'"]'),d.length&&d.trigger("click")):(f.show(),this._viewChanged(this.options.views.active));this.options.views.thumbs&&this._displayThumbs()},_enableSortingList:function(){var a=this;2>c(".plupload_file",
this.filelist).length||(c("tbody",this.filelist).sortable("destroy"),this.filelist.sortable({items:".plupload_delete",cancel:"object, .plupload_clearer",stop:function(){var b=[];c.each(c(this).sortable("toArray"),function(c,d){b[b.length]=a.uploader.getFile(d)});b.unshift(b.length);b.unshift(0);Array.prototype.splice.apply(a.uploader.files,b)}}))}})})(window,document,plupload,mOxie,jQuery);
